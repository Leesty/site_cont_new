# Аудит сайта (Django): баги и эксплойты

Проверены только приложение сайта: `core/`, `base_site/`, `templates/`. Бот не рассматривался.

---

## Вывод по безопасности

- **Эксплойтов не найдено:** обычный пользователь не может получить права staff/support, войти в Django Admin или читать чужие данные через подмену ID.
- **Доступ к разделам:** все staff-маршруты защищены `_require_support()`; пользовательские представления фильтруют данные по `request.user`.
- **Шаблоны:** нет `|safe` / `mark_safe` — вывод с автоэкранированием, явных XSS нет.
- **Редиректы:** везде именованные URL или внутренние pk, открытых редиректов нет.

---

## 1. Баги и риски на сайте

### 1.1 Дублирование заявок «Обратиться»

**Где:** `request_contact_create` (views.py).

Пользователь может многократно нажимать «Обратиться» или отправлять POST на `contacts/request/`. Каждый раз создаётся новая запись `ContactRequest` со статусом `pending`. В списке заявок у staff появятся дубликаты, возможен спам.

**Рекомендация:** перед созданием проверять, есть ли уже необработанная заявка от этого пользователя (и при необходимости по той же базе), например:

```python
if ContactRequest.objects.filter(user=request.user, status="pending").exists():
    messages.info(request, "У вас уже есть активная заявка. Ожидайте ответа.")
    return redirect("contacts")
```

---

### 1.2 Параметр `page` в пагинации

**Где:** `admin_user_leads_list` — `page_number = request.GET.get("page", 1)` и `paginator.get_page(page_number)`.

В Django `Paginator.get_page()` корректно обрабатывает нечисловые и внедиапазонные значения (возвращает первую/последнюю страницу). Падения нет, риска нет.

---

### 1.3 Имя файла в Content-Disposition

**Где:** выгрузки Excel и TXT — в заголовке подставляются `target_user.username` или `base_type.slug`.

В модели User `username` ограничен валидатором (буквы, цифры, @.+-_), в BaseType `slug` — штатно. Теоретически при ручном изменении в админке в slug/username могут попасть кавычки или переносы строк и сломать заголовок или упростить injection в ответ.

**Рекомендация:** формировать безопасное имя файла: убрать/заменить символы `" \ \n \r`, ограничить длину, например:

```python
safe_name = "".join(c for c in (base_type.slug or "base") if c.isalnum() or c in "._-")[:50] or "base"
```

---

### 1.4 Загрузка файлов (лиды, поддержка)

**Где:** `LeadReportForm` (скриншот лида), сообщения поддержки (attachment).

- Размер ограничен настройками Django (`DATA_UPLOAD_MAX_MEMORY_SIZE` и т.п.), по умолчанию порядка 2.5 MB.
- Тип файла не проверяется: можно загрузить не только изображение. Для лидов потом вызывается `compress_lead_attachment()` — для не-картинок она просто выходит, файл остаётся как есть. RCE нет (Django файлы не выполняет), но можно засорять хранилище и раздавать нежелательные типы по ссылке.

**Рекомендация:** в форме или во view проверять расширение и/или content-type (например, только image/jpeg, image/png, image/webp для скриншотов лидов) и при необходимости ограничить максимальный размер явно.

---

### 1.5 Доступ к медиафайлам (скриншоты лидов)

При `DEBUG=True` Django раздаёт файлы из `MEDIA_ROOT` по URL вида `/media/...`. Тот, у кого есть ссылка (например, из Excel-выгрузки для staff), может открыть файл без дополнительной проверки прав.

**Рекомендация:** в продакшене не раздавать `media` напрямую через Django; отдавать через веб-сервер или отдельный view с проверкой: запрос от владельца лида или от staff.

---

## 2. Что проверено и признано корректным

- **Регистрация:** в форму передаются только `username` и пароль, `role`/`is_staff`/`status` из запроса не принимаются — эскалации привилегий через сайт нет.
- **Django Admin:** доступ только при `is_staff=True`, выставить это через сайт нельзя.
- **Staff-представления:** везде в начале вызывается `_require_support()`; при отказе — 403. Подмена `user_id` в URL не даёт обычному пользователю доступа (он не пройдёт проверку прав).
- **Контакты:** везде фильтр `assigned_to=request.user` или выдача только для своего пользователя.
- **Лиды:** создание с `lead.user = request.user`; просмотр своих лидов и статистики — по `user=user`.
- **Поддержка:** пользователь видит только свой тред (`get_or_create(user=request.user)`); доступ к чужим диалогам — только через staff-views с `_require_support`.
- **Выдача контактов:** используется `select_for_update()` внутри `transaction.atomic()` — гонки при выдаче учтены.
- **Одобрение/бан в pending:** POST с `user_id` и `action` обрабатывается только после `_require_support()`, подделать запрос от имени не-staff нельзя.
- **Обработка заявок на контакты:** обрабатывается только заявка со статусом `pending`, объект берётся по `pk` и `status="pending"` — лишние изменения через подмену `request_id` ограничены логикой (например, повторная обработка одной и той же заявки даёт лишь повторное увеличение лимита).

---

## 3. Рекомендации по усилению (без критичных дыр)

| Что | Действие |
|-----|----------|
| Заявки «Обратиться» | Не создавать новую, если уже есть pending от этого пользователя (и при необходимости по той же базе). |
| Имена файлов в выгрузках | Санитизировать `username`/`slug` для использования в Content-Disposition. |
| Загрузка вложений | Проверять тип/расширение и при необходимости размер для скриншотов лидов и вложений в поддержке. |
| Медиа в проде | Раздавать через nginx/view с проверкой прав, не отдавать всё подряд из MEDIA_ROOT. |
| Логин | Рассмотреть ограничение попыток входа (например, django-axes или throttle по IP), чтобы снизить риск перебора паролей. |
| Пароли | Включить `AUTH_PASSWORD_VALIDATORS` в продакшене. |

---

## 4. Краткие ответы

- **Утечки данных?** — Нет: чужие лиды, контакты и диалоги по веб-интерфейсу недоступны обычному пользователю. Риск только у прямой ссылки на медиафайл при известном URL.
- **Взлом / эскалация прав?** — Типичных эксплойтов в коде не видно; риск остаётся из-за слабых паролей, перебора и утечки секретов.
- **Может ли юзер стать админом / зайти в /admin/?** — Нет: права и вход в админку не выставляются через формы/views сайта.
- **Баги?** — Есть один явный: возможность создавать неограниченное число заявок «Обратиться»; остальное — усиление (файлы, имена, медиа, логин).
