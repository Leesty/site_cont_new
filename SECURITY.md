# Аудит безопасности (краткий отчёт)

## Вывод: критических эксплойтов не найдено

- **Обычный пользователь не может получить админские права** через веб-интерфейс.
- **Вход в Django Admin (`/admin/`)** возможен только для пользователей с `is_staff=True`. Это поле задаётся только через Django Admin или напрямую в БД (shell/migration), в формах и представлениях сайта оно нигде не выставляется.
- **Разделы staff** (статистика, пользователи, лиды, базы, поддержка) защищены: перед логикой везде вызывается `_require_support()` — доступ только при `role in (support, admin)` или `is_staff` / `is_superuser`.

---

## Что проверено

### 1. Регистрация и эскалация привилегий

- `UserRegistrationForm` создаёт пользователя только с полями `username` и пароль (Meta.fields = `("username",)`). Поля `role`, `status`, `is_staff`, `is_superuser` из запроса не принимаются и не меняются.
- Одобрение/бан в `admin_users_pending` меняет только `status` (APPROVED/BANNED), не `role` и не `is_staff`.
- Нет ни одного представления, где обычный пользователь мог бы изменить себе `role`, `is_staff` или `is_superuser`.

**Итог:** повысить привилегии через сайт нельзя.

### 2. Доступ в Django Admin

- Маршрут `/admin/` ведёт в стандартную админку Django. Доступ к ней контролируется флагом `is_staff` (стандартное поведение Django).
- У пользователей, созданных через регистрацию, `is_staff=False`. Выставить `is_staff=True` можно только через уже залогиненного в админке сотрудника или через `manage.py shell` / миграции.

**Итог:** обычный юзер не может «войти в админку Django» со своим аккаунтом.

### 3. Защита staff-разделов

- Все представления с префиксом `staff/` и разделы поддержки (списки диалогов, диалог по `pk`, удаление сообщений/топиков) в начале вызывают `@login_required` и `_require_support(request)`. При отказе возвращается `HttpResponseForbidden`.
- Просмотр лидов/статистики другого пользователя по `user_id` доступен только сотрудникам; обычный пользователь не может подставить чужой `user_id` и получить данные — его запрос завершится 403.

**Итог:** IDOR по `user_id` для обычного пользователя исключён.

### 4. Изоляция данных пользователя

- Контакты: везде фильтр `assigned_to=request.user` (или явно свой пользователь).
- Лиды: создание только с `lead.user = request.user`; просмотр своих лидов — по `user=user` (текущий пользователь).
- Поддержка: пользователь видит только свой диалог (`get_or_create(user=request.user)`); доступ к чужим диалогам только через staff-представления с `_require_support`.

**Итог:** утечки чужих данных через «свои» страницы нет.

### 5. CSRF и сессии

- В `MIDDLEWARE` включён `CsrfViewMiddleware` — POST-запросы без корректного CSRF-токена отклоняются.
- Используется стандартная аутентификация Django (сессии, логин/логаут).

### 6. Секреты и отладка

- `SECRET_KEY` и `DEBUG` берутся из переменных окружения (например, `.env`). В продакшене нужно задать свой `SECRET_KEY` и `DEBUG=False`.
- В репозитории не должны попадать `.env`, `media/`, БД — в `.gitignore` это учтено.

### 7. Опасный код

- В коде представлений и форм не используется `raw` SQL, `eval`/`exec` и подобные конструкции с пользовательским вводом.

---

## Рекомендации по усилению

1. **Пароли**  
   Сейчас `AUTH_PASSWORD_VALIDATORS = []`. Для продакшена желательно включить стандартные валидаторы Django (длина, совпадение, распространённые пароли), чтобы снизить риск слабых паролей.

2. **HTTPS и куки**  
   В продакшене при работе по HTTPS стоит включить:
   - `SESSION_COOKIE_SECURE = True`
   - `CSRF_COOKIE_SECURE = True`
   - При необходимости `SESSION_COOKIE_HTTPONLY = True` (по умолчанию уже True в современных версиях Django).

3. **Медиафайлы (скриншоты лидов, вложения поддержки)**  
   При `DEBUG=True` Django раздаёт файлы из `MEDIA_ROOT` по URL вида `/media/...`. Тот, у кого есть прямая ссылка (например, из Excel-выгрузки), может открыть файл без дополнительной проверки прав. Рекомендации:
   - В продакшене не раздавать `media` через Django, а отдавать их через веб-сервер (nginx/apache) с отдельным location и при необходимости проверкой авторизации (например, внутренний редирект после проверки в приложении).
   - Либо оставить раздачу через Django, но отдавать файлы только через отдельное view, где проверяется, что запрос от владельца лида/диалога или от сотрудника поддержки.

4. **Загрузка файлов**  
   Для форм с прикреплением файлов (лиды, поддержка) можно добавить проверку: максимальный размер файла, разрешённые расширения или MIME-типы (например, только изображения для скриншотов), чтобы снизить риск DoS и загрузки нежелательного контента.

5. **ALLOWED_HOSTS**  
   В продакшене обязательно задать `DJANGO_ALLOWED_HOSTS` списком реальных доменов, без лишних запятых и пробелов.

---

## Краткие ответы на вопросы

- **Есть ли утечки?** — Чужие лиды/контакты/диалоги через веб-интерфейс обычному пользователю недоступны. Потенциальная утечка — прямая ссылка на медиафайл при известном URL (см. п. 3 выше).
- **Возможен ли взлом?** — Типичных эксплойтов (эскалация привилегий, IDOR, обход проверок доступа) в коде не видно. Риск остаётся из-за слабых паролей, открытого HTTP или утечки секретов из окружения.
- **Может ли обычный юзер получить админские права?** — Нет: ни через регистрацию, ни через одобрение, ни через другие представления.
- **Может ли войти в админку Django?** — Нет: доступ в `/admin/` только при `is_staff=True`, выставить это через сайт пользователь не может.
